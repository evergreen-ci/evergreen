name: Sync GraphQL Schema to UI

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "graphql/schema/**"

concurrency:
  group: sync-graphql-schema
  cancel-in-progress: false

jobs:
  sync-schema:
    name: Sync GraphQL Schema and Open PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout evergreen repo
        uses: actions/checkout@v4
        with:
          path: evergreen

      - name: Clone evergreen-ci/ui repo
        run: git clone https://x-access-token:${{ secrets.EVERGREEN_UI_TOKEN }}@github.com/evergreen-ci/ui.git ui

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.18.0"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Install UI dependencies
        working-directory: ui
        run: pnpm install --frozen-lockfile

      - name: Create sdlschema symlinks
        run: |
          ln -s ${{ github.workspace }}/evergreen/graphql/schema ui/apps/spruce/sdlschema
          ln -s ${{ github.workspace }}/evergreen/graphql/schema ui/apps/parsley/sdlschema
          ln -s ${{ github.workspace }}/evergreen/graphql/schema ui/packages/lib/sdlschema

      - name: Run codegen
        working-directory: ui
        run: pnpm codegen

      - name: Check for changes
        id: changes
        working-directory: ui
        run: |
          if git diff --quiet -- \
            apps/spruce/src/gql/generated/types.ts \
            apps/parsley/src/gql/generated/types.ts \
            packages/lib/src/gql/generated/types.ts; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for existing PR
        if: steps.changes.outputs.has_changes == 'true'
        id: existing_pr
        env:
          GH_TOKEN: ${{ secrets.EVERGREEN_UI_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list \
            --repo evergreen-ci/ui \
            --head "evergreen/sync-graphql-schema" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=$EXISTING_PR" >> "$GITHUB_OUTPUT"
          else
            echo "pr_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch, commit, and push
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: ui
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="evergreen/sync-graphql-schema"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          git checkout -B "$BRANCH"
          git add apps/spruce/src/gql/generated/types.ts
          git add apps/parsley/src/gql/generated/types.ts
          git add packages/lib/src/gql/generated/types.ts
          git commit -m "Update generated GraphQL types from evergreen@${SHORT_SHA}"
          git push --force-with-lease origin "$BRANCH"

      - name: Create pull request
        if: steps.changes.outputs.has_changes == 'true' && steps.existing_pr.outputs.pr_exists == 'false'
        working-directory: ui
        env:
          GH_TOKEN: ${{ secrets.EVERGREEN_UI_TOKEN }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${COMMIT_SHA}"
          COMMIT_MSG=$(cd ${{ github.workspace }}/evergreen && git log -1 --format='%s')

          gh pr create \
            --repo evergreen-ci/ui \
            --head "evergreen/sync-graphql-schema" \
            --base main \
            --title "Update GraphQL types from evergreen@${SHORT_SHA}" \
            --body "$(cat <<EOF
          ## Summary

          Automated PR to sync generated GraphQL types after schema changes in the evergreen repo.

          Triggered by commit [\`${SHORT_SHA}\`](${COMMIT_URL}): ${COMMIT_MSG}

          ### Changed files
          - \`apps/spruce/src/gql/generated/types.ts\`
          - \`apps/parsley/src/gql/generated/types.ts\`
          - \`packages/lib/src/gql/generated/types.ts\`

          ---
          *This PR was automatically generated by the [sync-graphql-schema](https://github.com/${{ github.repository }}/actions/workflows/sync-graphql-schema.yml) workflow.*
          EOF
          )"

      - name: Update existing pull request
        if: steps.changes.outputs.has_changes == 'true' && steps.existing_pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.EVERGREEN_UI_TOKEN }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${COMMIT_SHA}"
          COMMIT_MSG=$(cd ${{ github.workspace }}/evergreen && git log -1 --format='%s')

          gh pr comment "${{ steps.existing_pr.outputs.pr_number }}" \
            --repo evergreen-ci/ui \
            --body "Updated with changes from evergreen commit [\`${SHORT_SHA}\`](${COMMIT_URL}): ${COMMIT_MSG}"
