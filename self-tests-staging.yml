include:
  - filename: self-tests.yml

containers:
  - name: evg-container
    working_dir: /
    image: "hadjri/evg-container-self-tests"
    resources:
      cpu: 4096
      memory_mb: 8192
    system:
      cpu_architecture: x86_64
      operating_system: linux

buildvariants:
  - name: ubuntu2004-container
    display_name: Ubuntu 20.04 (Container)
    run_on:
      - evg-container
    expansions:
      goos: linux
      goarch: amd64
      IS_DOCKER: true
      GOROOT: /usr/local/go
      mongodb_url: https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2004-5.0.14.tgz
      decompress: tar zxvf
    tasks:
      - name: "dist-unsigned"
      - name: ".smoke"
      - name: ".test"
      - name: "js-test"
      - name: test-db-auth
  - name: kim-test-1
    display_name: Kim's Dependency Test (1)
    run_on:
      - ubuntu2004-small
    tasks:
      - child-task
  - name: kim-test-2
    display_name: Kim's Dependency Test (2)
    run_on:
      - ubuntu2004-small
    tasks:
      - parent-task-0
      - parent-group

tasks:
  - name: child-task
    depends_on:
      - name: parent-task-0
        variant: '*'
      - name: parent-task-2-0
        variant: '*'
    commands:
      - command: shell.exec
        params:
          script: "echo ${task_name}"
  - name: parent-task-0
    commands:
      - command: shell.exec
        params:
          script: "echo ${task_name}"
  - name: parent-task-1-0
    depends_on:
      - name: parent-task-0
    commands:
      - command: shell.exec
        params:
          script: "echo ${task_name}"
  - name: parent-task-2-0
    depends_on:
      - name: parent-task-0
    commands:
      - command: shell.exec
        params:
          script: "echo ${task_name}"

task_groups:
  - name: parent-group
    max_hosts: 2
    tasks:
      - parent-task-1-0
      - parent-task-2-0
