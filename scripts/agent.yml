command_type: test
stepback: false


task_groups:
  - name: my_group
    max_hosts: 1
    setup_group:
    - command: shell.exec
      params:
        script: |
          set -o verbose
          set -o errexit
          echo "setup_group"
    teardown_group:
    - command: shell.exec
      params:
        script: |
          set -o verbose
          set -o errexit
          echo "teardown_group"
    setup_task:
    - command: shell.exec
      params:
        script: |
          set -o verbose
          set -o errexit
          echo "setup_task"
    teardown_task:
    - command: shell.exec
      params:
        script: |
          set -o verbose
          set -o errexit
          echo "teardown_task"
    tasks:
      - first_task_in_task_group
      - second_task_in_task_group
      - test
      - third_task_in_task_group
      - fourth_task_in_task_group

tasks:
  - name: first_task_in_task_group
    commands:
      - command: shell.exec
        params:
          script: |
            set -o verbose
            set -o errexit
            echo "first"
  - name: second_task_in_task_group
    commands:
      - command: shell.exec
        params:
          script: |
            set -o verbose
            set -o errexit
            echo "second"
  - name: third_task_in_task_group
    commands:
      - command: shell.exec
        params:
          script: |
            set -o verbose
            set -o errexit
            echo "third"
  - name: fourth_task_in_task_group
    commands:
      - command: shell.exec
        params:
          script: |
            set -o verbose
            set -o errexit
            echo "fourth"
  - name: test
    commands:
      - command: git.get_project
        params:
          directory: src
      - command: shell.exec
        params:
          script: |
            set -o verbose
            set -o errexit
            echo "hi"

            # files to archive.targz_pack
            mkdir archive
            touch archive/a_to_archive
            touch archive/b_to_archive

            # file to s3.put
            mkdir upload
            echo ${task_name} > upload/s3
      - command: subprocess.exec
        params: 
          working_dir: archive
          binary: /bin/bash
          args: 
            - "-c"
            - "touch foo"
      - command: subprocess.exec
        params: 
          working_dir: archive
          command: "/usr/bin/touch bar"
      - command: archive.targz_pack
        params:
          target: "archive.tgz"
          source_dir: "archive"
          include:
            - "*_to_archive"
      - command: archive.targz_extract
        params:
          path: "archive.tgz"
          destination: "output"
      - command: archive.zip_pack
        params:
          target: "archive.zip"
          source_dir: "archive"
          include:
            - "*_to_archive"
      - command: archive.zip_extract
        params:
          path: "archive.zip"
          destination: "output"
      - command: archive.auto_extract
        params:
          path: "archive.zip"
          destination: "output"
      - command: archive.auto_extract
        params:
          path: "archive.tar.gz"
          destination: "output"
      - command: attach.results
        params:
          file_location: "src/command/testdata/attach/plugin_attach_results.json"
      - command: attach.xunit_results
        params:
          file: "src/command/testdata/xunit/junit_4.xml"
      - command: expansions.update
        params:
          foo: bar
      - command: gotest.parse_files
        params:
          files:
            - "src/command/testdata/gotest/4_simple.log"
      - command: json.send
        params:
          name: "foo"
          file: "src/command/testdata/attach/plugin_attach_results.json"
      - command: json.get_history
        params:
          task: ${task_name}
          file: "foo.json"
          name: "foo"
      - command: keyval.inc
        params:
          key: "test"
          destination: "test_num"
      - command: manifest.load
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: upload/s3
          remote_file: evergreen/smoke/${build_id}-${build_variant}/evergreen-${task_name}-${revision}
          bucket: mciuploads
          optional: "true"
          content_type: text/html
          permissions: public-read
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: upload/s3
          remote_file: evergreen/smoke/${build_id}-${build_variant}/evergreen-${task_name}-${revision}
          bucket: mciuploads
          optional: true
          content_type: text/html
          permissions: public-read
      - command: s3.get
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          remote_file: evergreen/smoke/${build_id}-${build_variant}/evergreen-${task_name}-${revision}
          bucket: mciuploads
          local_file: upload/s3-get
      - command: s3Copy.copy
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          s3_copy_files:
              - {'source': {'path': 'evergreen/smoke/${build_id}-${build_variant}/evergreen-${task_name}-${revision}', 'bucket': 'mciuploads'},
                'destination': {'path': 'evergreen/smoke/${build_id}-${build_variant}/evergreen-${task_name}-${revision}-copy', 'bucket': 'mciuploads'}}

buildvariants:
  - name: localhost
    display_name: localhost
    run_on:
      - localhost
    tasks:
      - name: my_group
